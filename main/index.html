<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>test</title>

        <!--JQUERY-->
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

        <!--BOOSTRAP-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    </head>

    <body>
        <div class="text-center">
            <h1>PICK E DELIVERY</h1>
            <canvas id="myCanvas" width=421 height=574>
                Your browser does not support the canvas element.
            </canvas>

            <br/>

            <button class="btn btn-primary" id="pick">ASSEGNA UNA MISSIONE AL ROBOT</button>
            <button class="btn btn-primary" id="delivery">DELIVERY</button>
            <button class="btn btn-primary" id="goback">GOBACK</button>
            <button class="btn btn-primary" id="free">FREE</button>
            <button class="btn btn-primary" id="disabled" disabled>IL ROBOT &Egrave; IN MISSIONE</button>
            <div id="timeout"></div>
        </div>

        <script type="text/javascript" type="text/javascript">
            var ws = new WebSocket("ws://localhost:3000/");
            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");
            var base_image = new Image();
            var user;
            var sender = "none";
            var receiver = "none";
            var blocked = 0;
            base_image.src = 'http://localhost:3000/map';

            function int2Status(n) {
                switch(n) {
                    case 0: return "FREE"; break;
                    case 1: return "PICK"; break;
                    case 2: return "AT_SRC"; break;
                    case 3: return "DELIVERY"; break;
                    case 4: return "AT_DST"; break;
                    case 5: return "GOBACK"; break;
                    default: return "STATO NON RICONOSCIUTO"; break;
                }
            }

            function setBtn(btn,view,msg) {
                if(view == 0) $(btn).hide();
                else $(btn).show();
                $(btn).text(msg);
            }

            $.ajax({
                type: "GET",
                url: "http://localhost:3000/user_data",
                success: function(data) {
                    user = data;
                },
                error: function() {
                    alert("Errore");
                }
            });

            setBtn("#pick",1,"HAI UN PACCO DA SPEDIRE? CHIAMA IL NOSTRO ROBOT!");
            setBtn("#delivery",0,"");
            setBtn("#goback",0,"");
            setBtn("#free",0,"");
            setBtn("#disabled",0,"");

            window.onload = function() {
                base_image.onload = function(){
                    ctx.drawImage(base_image, 0, 0);
                    ctx.rotate(90 * Math.PI / 180);
                }
            }

            ws.onmessage = function(event) {
                let data = JSON.parse(event.data);
                
                if(typeof(data.event) != "undefined") { 
                    switch(data.event) {
                        case "isBlocked": {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È BLOCCATO, SERVIZIO MOMENTANEAMENTE NON DISPONIBILE");
                            blocked = 1;
                            break;
                        }
                        case "tooLongPick": {
                            if(user.id == sender)
                                alert("IL ROBOT NON È IN GRADO DI RAGGIUNGERTI, CI SCUSIAMO PER IL DISAGIO");
                            blocked = 0;
                            break;
                        }
                        case "tooLongDelivery": {
                            if(user.id == sender)
                                alert("IL ROBOT NON È IN GRADO DI RAGGIUNGERE IL DESTINATARIO, STA ORA TORNANDO INDIETRO, CI SCUSIAMO PER IL DISAGIO");
                            blocked = 0;
                            break;
                        }
                        case "noPack": {
                            if(user.id == sender)
                                alert("L'UTENTE NON HA MESSO NESSUN PACCO SUL ROBOT, LA MISSIONE È STATA ANNULLATA");
                            blocked = 0;
                            break;
                        }
                        default: {
                            blocked = 0;
                            break;
                        }
                    }
                }

                if(blocked == 1) return;

                sender = data.position.sender;
                receiver = data.position.receiver;
                let x = data.position.x/0.05-3.5;
                let y = 574-3.5-data.position.y/0.05;

                ctx.fillStyle = "#FF0000";

                //x/0.05, y/0.05, inizia a disegnare in alto a sinistra
                /*
                'april_tag.png': 281x547
                'april_tag_scale.png': 421x574
                */

                ctx.drawImage(base_image, 0, 0);
                ctx.fillRect(x,y,7,7);
                //$("p").text(data.position.status_msg+"\n"+data.position.sender+"\n"+data.position.receiver+"\n"+JSON.stringify(data.online));

                if(data.position.status != 0) {
                    ctx.fillStyle = "#FFFF00";
                    x = data.goal.pose.position.x/0.05-3.5;
                    y = 574-3.5-data.goal.pose.position.y/0.05;

                    //x = data.goal.x/0.05-3.5;
                    //y = 574-3.5-data.goal.y/0.05;
                    
                    ctx.beginPath();

                    ctx.moveTo(x - 10, y - 10);
                    ctx.lineTo(x + 10, y + 10);

                    ctx.moveTo(x + 10, y - 10);
                    ctx.lineTo(x - 10, y + 10);
                    ctx.stroke()
                }

                //GESTIONE BOTTONI IN BASE STATO DEL ROBOT
                switch(int2Status(data.position.status)) {
                    case "FREE": {
                        setBtn("#pick",1,"HAI UN PACCO DA SPEDIRE? CHIAMA IL NOSTRO ROBOT!");
                        setBtn("#delivery",0,"");
                        setBtn("#goback",0,"");
                        setBtn("#free",0,"");
                        setBtn("#disabled",0,"");
                        break;
                    }
                    case "PICK": {
                        if(user.id == sender) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",1,"ANNULLA QUESTA MISSIONE");
                            setBtn("#disabled",0,"");
                        }
                        else {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È IN MISSIONE");
                        }
                        break;
                    }
                    case "AT_SRC": {
                        if(user.id == sender) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",1,"CARICA UN PACCO E SCEGLI A CHI MANDARLO!");
                            setBtn("#goback",0,"");
                            setBtn("#free",1,"ANNULLA QUESTA MISSIONE");
                            setBtn("#disabled",0,"");
                        }
                        else {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È IN MISSIONE");
                        }
                        break;
                    }
                    case "DELIVERY": {
                        if(user.id == sender) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",1,"HAI CAMBIATO IDEA? RICHIAMA IL ROBOT!");
                            setBtn("#free",0,"");
                            setBtn("#disabled",0,"");
                        }
                        else if(user.id == receiver) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"QUALCUNO HA UN PACCO PER TE!");
                        }
                        else {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È IN MISSIONE");
                        }
                        break;
                    }
                    case "AT_DST": {
                        if(user.id == sender) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",1,"HAI CAMBIATO IDEA? RICHIAMA IL ROBOT!");
                            setBtn("#free",0,"");
                            setBtn("#disabled",0,"");
                        }
                        else if(user.id == receiver) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",1,"HO PRESO IL PACCO!");
                            setBtn("#disabled",0,"");
                        }
                        else {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È IN MISSIONE");
                        }
                        break;
                    }
                    case "GOBACK": {
                        if(user.id == sender) {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"0");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"HAI ANNULLATO QUESTA MISSIONE, IL ROBOT STA TORNANDO INDIETRO");
                        }
                        else {
                            setBtn("#pick",0,"");
                            setBtn("#delivery",0,"");
                            setBtn("#goback",0,"");
                            setBtn("#free",0,"");
                            setBtn("#disabled",1,"IL ROBOT È IN MISSIONE");
                        }
                        break;
                    }
                    default: {
                        setBtn("#pick",0,"");
                        setBtn("#delivery",0,"");
                        setBtn("#goback",0,"");
                        setBtn("#free",0,"");
                        setBtn("#disabled",0,"");
                        break;
                    }
                }
            }


            $("#pick").click(function() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:3000/move_robot?action=PICK&user="+user.id+"&password="+user.password+"&goal="+user.id,
                    success: function(data) {
                        console.log(data);
                    },
                    error: function() {
                        alert("Errore");
                    }
                });
            });

            $("#delivery").click(function() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:3000/move_robot?action=DELIVERY&user="+user.id+"&password="+user.password+"&goal="+"marcorossi@gmail.com",
                    success: function(data) {
                        console.log(data);
                    },
                    error: function() {
                        alert("Errore");
                    }
                });
            });

            $("#goback").click(function() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:3000/move_robot?action=GOBACK&user="+user.id+"&password="+user.password+"&goal="+user.id,
                    success: function(data) {
                        console.log(data);
                    },
                    error: function() {
                        alert("Errore");
                    }
                });
            });

            $("#free").click(function() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:3000/move_robot?action=FREE&user="+user.id+"&password="+user.password+"&goal="+user.id,
                    success: function(data) {
                        console.log(data);
                    },
                    error: function() {
                        alert("Errore");
                    }
                });
            });

        </script>
    </body>
</html>
